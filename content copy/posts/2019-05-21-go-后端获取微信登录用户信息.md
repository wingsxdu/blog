---
title: Go 后端获取微信登录用户信息
author: beihai
type: post
date: 2019-05-21T08:59:55+00:00
url: /?p=1185
hestia_layout_select:
  - sidebar-right
  - sidebar-right
categories:
  - Golang
  - 技术向

---
若想获取微信登录用户的私密信息，如 openid、unionid 等，流程为：用户确认登录后获取临时 code，有效期为5分钟；将 code 发送至后端，后端向微信服务器执行 https get 请求，获取私密信息。

##### 准备工作

###### get 请求

<pre class="pure-highlightjs"><code class="null">package api
import (
    "DistributedData/debug"
    "bytes"
    "encoding/json"
    "io"
    "io/ioutil"
    "net/http"
    "time"
)
func Get(url string)  string {
    client := http.Client{Timeout: 5 * time.Second}
    response,  err := client.Get(url)
    debug.CheckErr(err)
    defer response.Body.Close()
    var buffer [512]byte
    result := bytes.NewBuffer(nil)
    for {
        n, err := response.Body.Read(buffer[0:])
        result.Write(buffer[0:n])
        if err != nil && err == io.EOF {
            break
        } else if err != nil {
            panic(err)
        }
    }
    return result.String()
}</code></pre>

###### Models 结构体数据

<pre class="pure-highlightjs"><code class="null">package models
type WeChat struct {
    Openid      string `json:"Openid" `
    Session_key string `json:"Session_key"`
    Unionid     string `json:"unionid"`
    Errcode     string `json:"Errcode"`
    Errmsg      string `json:"Errmsg"`
}</code></pre>

##### 微信登录

###### 路由

<pre class="pure-highlightjs"><code class="null">e.POST("/wechatlogin", action.WeChatLogin)</code></pre>

<pre class="pure-highlightjs"><code class="null">func WeChatLogin(c echo.Context) error {
    code := c.FormValue("code")
    msg := api.Get("https://api.weixin.qq.com/sns/jscode2session?appid=" + base.WeChatAppId + "&secret=" +
        base.WeChatSecret+"&js_code=" + code +"&grant_type=authorization_code")
    var WeChat = models.WeChat{}
    err := json.Unmarshal([]byte(msg), &WeChat)
    debug.CheckErr(err)
    password := WeChat.Unionid
    fmt.Println(WeChat.Openid)
    return c.JSON(http.StatusOK, WeChat.Openid)
 }</code></pre>